generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model LeadTunnel {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Canal principal d’entrée
  primaryChannel    String   // 'web' | 'whatsapp'

  // Données contact
  firstName         String?
  lastName          String?
  email             String?
  phone             String?

  // Suivi de progression
  formCompletionStatus String @default("none")   // 'none' | 'partial' | 'complete'
  photoStatus          String @default("none")   // historique WhatsApp (non utilisé en V1 photos)
  photosStatus         String @default("NONE")   // 'NONE' | 'PENDING' | 'UPLOADED'

  // Liaison Web ↔ WhatsApp
  linkingToken      String? @unique
  whatsappThreadId  String?

  // Source marketing / site d’origine
  source            String?

  // Champs du formulaire contact & projet
  originPostalCode      String?
  originCity            String?
  originAddress         String?
  destinationPostalCode String?
  destinationCity       String?
  destinationAddress    String?
  movingDate            String? // ISO date string
  details               String? // Champ "détails utiles"

  // Estimation volume & formule choisie
  housingType      String? // 'studio' | 't1' | 't2' | 't3' | 't4' | 't5' | 'house'
  surfaceM2        Int?
  density          String? // 'light' | 'normal' | 'dense'
  formule          String? // 'ECONOMIQUE' | 'STANDARD' | 'PREMIUM'
  volumeM3         Float?
  distanceKm       Float?
  priceMin         Int?
  priceMax         Int?

  photos           LeadPhoto[]
  rooms            LeadRoom[]
}

model LeadPhoto {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())

  // Lien vers le lead tunnel
  leadId           String
  lead             LeadTunnel @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Lien éventuel vers une pièce
  roomId           String?
  room             LeadRoom?  @relation(fields: [roomId], references: [id])

  // Stockage
  storageKey       String
  url              String?

  originalFilename String
  mimeType         String
  sizeBytes        Int

  // Préparation future pour l'analyse IA
  analysisStatus   String   @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'ERROR'
}

model LeadRoom {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadId   String
  lead     LeadTunnel @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Type de pièce et index (ex: CHAMBRE + 1 => "Chambre 1")
  roomType  String   // 'ENTREE' | 'SALON' | 'CUISINE' | 'CHAMBRE' | ...
  roomIndex Int?
  label     String

  coverPhotoId String?

  // Statuts d'analyse et d'inventaire
  analysisStatus   String @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'ERROR'
  inventoryStatus  String @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'ERROR'

  photos  LeadPhoto[]
  items   LeadRoomItem[]
}

model LeadRoomItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roomId LeadRoom @relation(fields: [roomIdId], references: [id], onDelete: Cascade)
  roomIdId String

  label    String
  category String
  quantity Int
  confidence Float

  notes               String?
  isFragile           Boolean @default(false)
  isHighValue         Boolean @default(false)
  requiresDisassembly Boolean @default(false)
}


