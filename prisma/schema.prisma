generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model LeadTunnel {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Lien vers le Back Office (Lead.id côté PostgreSQL)
  backofficeLeadId  String?  @unique

  // Canal principal d'entrée
  primaryChannel    String   // 'web' | 'whatsapp'

  // Données contact
  firstName         String?
  lastName          String?
  email             String?
  phone             String?

  // Suivi de progression
  formCompletionStatus String @default("none")   // 'none' | 'partial' | 'complete'
  photoStatus          String @default("none")   // historique WhatsApp (non utilisé en V1 photos)
  photosStatus         String @default("NONE")   // 'NONE' | 'PENDING' | 'UPLOADED'

  // Liaison Web ↔ WhatsApp
  linkingToken      String? @unique
  whatsappThreadId  String?

  // Source marketing / site d’origine
  source            String?

  // Champs du formulaire contact & projet
  originPostalCode      String?
  originCity            String?
  originAddress         String?
  destinationPostalCode String?
  destinationCity       String?
  destinationAddress    String?
  movingDate            String? // ISO date string
  details               String? // Champ "détails utiles"

  // Estimation volume & formule choisie
  housingType      String? // 'studio' | 't1' | 't2' | 't3' | 't4' | 't5' | 'house'
  surfaceM2        Int?
  density          String? // 'light' | 'normal' | 'dense'
  formule          String? // 'ECONOMIQUE' | 'STANDARD' | 'PREMIUM'
  volumeM3         Float?
  distanceKm       Float?
  priceMin         Int?
  priceMax         Int?

  photos           LeadPhoto[]
  rooms            LeadRoom[]
  analysisRuns     LeadAnalysisRun[]
}

model LeadPhoto {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())

  // Lien vers le lead tunnel
  leadId           String
  lead             LeadTunnel @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Lien éventuel vers une pièce
  roomId           String?
  room             LeadRoom?  @relation(fields: [roomId], references: [id])

  // Stockage
  storageKey       String
  url              String?

  originalFilename String
  mimeType         String
  sizeBytes        Int

  // Préparation future pour l'analyse IA
  // analysisStatus : pipeline global (ex: inventaire complet)
  analysisStatus           String   @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'ERROR'

  // Étape A – classification par pièce (Process 2)
  roomClassificationStatus String   @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'AMBIGU' | 'ERROR'
  roomGuessPrimary         String?
  roomGuessConfidence      Float?
  roomGuessAlternatives    Json?
}

model LeadRoom {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leadId   String
  lead     LeadTunnel @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Type de pièce et index (ex: CHAMBRE + 1 => "Chambre 1")
  roomType  String   // 'ENTREE' | 'SALON' | 'CUISINE' | 'CHAMBRE' | ...
  roomIndex Int?
  label     String

  coverPhotoId String?

  // Statuts d'analyse et d'inventaire
  analysisStatus   String @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'ERROR'
  inventoryStatus  String @default("NONE") // 'NONE' | 'PENDING' | 'DONE' | 'ERROR'

  photos  LeadPhoto[]
  items   LeadRoomItem[]

  @@unique([leadId, roomType, label])
}

model LeadRoomItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room       LeadRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId     String

  // Valeurs "finales" utilisées pour le dossier (après règles métier + éventuels ajustements client)
  label      String
  category   String
  quantity   Int
  confidence Float

  widthCm        Float?
  depthCm        Float?
  heightCm       Float?

  // Volumes et valeur utilisés pour le calcul logistique / devis
  volumeM3Nu       Float?
  volumeM3Emballé  Float?
  valueEstimateEur Float?

  // Informations de packaging (issues des règles métier)
  packagingFactor  Float?
  packagingReason  String?

  // Drapeaux d'objet
  isFragile           Boolean @default(false)
  isHighValue         Boolean @default(false)
  requiresDisassembly Boolean @default(false)

  // Lien hiérarchique (lit -> matelas, sommier ; cartons -> contenu, etc.)
  parentItemId String?
  parentItem   LeadRoomItem? @relation("LeadRoomItemChildren", fields: [parentItemId], references: [id])
  children     LeadRoomItem[] @relation("LeadRoomItemChildren")

  // Type de dérivé (ex: 'LIT_MATELAS', 'LIT_SOMMIER', 'ARMOIRE_CONTENU', 'CARTON_ITEM'…)
  derivedKind String?

  // Origine de la ligne (ai, manual, carton_aggregate, etc.)
  source     String? // 'ai' | 'manual' | 'carton'

  // Si l'utilisateur a explicitement retiré cet item de son inventaire
  isExcluded Boolean  @default(false)

  // Notes libres (debug, explications, etc.)
  notes      String?
}

model LeadAnalysisRun {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  leadId      String
  lead        LeadTunnel @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // ex: 'PROCESS1', 'PROCESS2'
  processType String
  model       String

  photosCount Int
  totalMs     Int

  // Évaluation manuelle de la qualité de l'inventaire (1–5 ou 1–10)
  qualityScore Int?
  qualityNotes String?
}



