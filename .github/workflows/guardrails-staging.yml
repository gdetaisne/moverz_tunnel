name: Guardrails (staging / tunnel v4)

on:
  pull_request:
  push:
    branches:
      - staging

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute changed files
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          # First commit on branch can have before = 0000... ; in that case, diff against HEAD~1 if possible.
          if [[ "${BASE_SHA}" =~ ^0+$ ]]; then
            if git rev-parse "${HEAD_SHA}~1" >/dev/null 2>&1; then
              BASE_SHA="$(git rev-parse "${HEAD_SHA}~1")"
            else
              BASE_SHA="${HEAD_SHA}"
            fi
          fi

          echo "Base: ${BASE_SHA}"
          echo "Head: ${HEAD_SHA}"

          CHANGED="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" | tr '\n' ' ')"
          echo "changed=${CHANGED}" >> "$GITHUB_OUTPUT"
          echo "Changed files: ${CHANGED}"

      - name: Block any Prisma migrations / schema edits
        shell: bash
        run: |
          set -euo pipefail
          CHANGED="${{ steps.changes.outputs.changed }}"

          if echo "$CHANGED" | grep -Eq '(^| )prisma/schema\.prisma( |$)'; then
            echo "ERROR: prisma/schema.prisma was modified. Migrations/schema changes are forbidden on staging V4."
            exit 1
          fi

          if echo "$CHANGED" | grep -Eq '(^| )prisma/migrations/'; then
            echo "ERROR: prisma/migrations/** was modified. Migrations are forbidden on staging V4."
            exit 1
          fi

      - name: Require migration_v4.md update for tunnel changes
        shell: bash
        run: |
          set -euo pipefail
          CHANGED="${{ steps.changes.outputs.changed }}"

          # Define what counts as "tunnel code" changes
          if echo "$CHANGED" | grep -Eq '(^| )(app/devis-gratuits|components/tunnel/|hooks/useTunnelTracking\.ts|hooks/useTunnelState\.ts|lib/analytics/ga4\.ts|lib/api/client\.ts)'; then
            if ! echo "$CHANGED" | grep -Eq '(^| )migration_v4\.md( |$)'; then
              echo "ERROR: Tunnel code changed but migration_v4.md was not updated."
              echo "Please update migration_v4.md and include the structured entry."
              exit 1
            fi
          fi

      - name: Validate required tunnel fields are not removed (TunnelFormState)
        shell: bash
        run: |
          set -euo pipefail
          node scripts/guardrails/check-formstate-required-keys.mjs

